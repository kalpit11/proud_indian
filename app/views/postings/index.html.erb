<div id='fb-root'></div>
<div class='row-fluid page'>
  <div class='span9 main-area'>
    <div class="search-area">
      <%= form_tag(postings_path,:method=>:get) do%>
        <%if current_user%>
          <a href="#new_post" data-toggle="modal" class="btn" >Post</a>
        <%end%>
        <%=text_field_tag "search[caption]",(params[:search].present? ? params[:search][:caption]: ''), :class=>"input-medium search-query span6", :placeholder=>"Search"%>
        <%=submit_tag "Search" , :class=>'btn btn-info'%>
      <% end %>

            <!-- Modal -->
      <div id="new_post" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
          <h3 id="myModalLabel">New Post</h3>
        </div>
        <div class="modal-body">
          <%@posting=Posting.new%>
          <%= render 'form' %>
        </div>
        <div class="modal-footer">
          <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
          <button class="btn btn-primary">Save changes</button>
        </div>
      </div>
      <!--end of model-->
    </div>
    
    <%@postings.each do |posting|%>
      <hr style="margin-left: -1%;margin-right: 1%;">
      <div id="post_<%=posting.id%>" class="post-area">
        <ul class="thumbnails">
          <div class="span1">
            <%img=User.where(:id => posting.user_id)[0]%>
            <%= image_tag(img.image_url)%>
            <h6><%= posting.user_name%></h6>
          </div>  
          <div class="span10">
            
            <h3><%= posting.caption%></h3>
            <%@pictures = posting.pictures%>
            <%@pictures.each do |picture|%>
              <li class="span4">
                <div class="thumbnail">
                  <a href="#picture_view-<%=posting.id%>" data-toggle="modal"><%= image_tag(picture.image_url,:style=>"width:300px;height:200px;")%></a>
                </div>
              </li>
            <%end%>

            <li class="span12"><p style="color: gray;"><%= posting.post%></p></li>
          </div>  
          <%if current_user%>
          <%if current_user.id==posting.user_id%>
            <div class="span1">
              <%= link_to image_tag("edit.png",:size=>"10x16"),edit_posting_path(posting)%>
              <%= link_to image_tag("delete.png",:size=>"10x16"),posting_path(posting), :method =>:delete%>
            </div>
          <%end%>  
        <%end%>
                    <!-- Modal -->
          <div id="picture_view-<%=posting.id%>" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
              <h3 id="myModalLabel-<%=posting.id%>"><%=posting.caption%></h3>
            </div>
            <div class="modal-body">
              <div id="myCarousel-<%=posting.id%>" class="carousel slide">
              <!-- Carousel items -->
              <div class="carousel-inner">
                <%@pictures = posting.pictures%>
                <%@pictures.each do |picture|%>
                
                  <div class="item"><%= image_tag(picture.image_url,:style=>"width:600px;height:400px;")%></div>
                
                <%end%>

              </div>
                
              <!-- Carousel nav -->
              <a class="carousel-control left" href="#myCarousel-<%=posting.id%>" data-slide="prev">&lsaquo;</a>
              <a class="carousel-control right" href="#myCarousel-<%=posting.id%>" data-slide="next">&rsaquo;</a>
            </div>
            </div>
            <div class="modal-footer">

              <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
              
            </div>
          </div>
          <!-- end of model -->



          <div class="clearfix"></div>         
        </ul>
        <%#binding.pry%>
        <div class="share-area offset1">
          <%if current_user%>
            <b class="like"><%=posting.post_likes.count%></b>&nbsp;
            <%if posting.post_likes.select{|c|c.user_id == current_user.id}.empty?%>
              <%= link_to "Like",add_like_path(posting),:class=>"like_post"%>
            <%else%>
              &nbsp;<a href="#">Like</a>
            <%end%>

            <!-- <a href="#" id='comment'>&nbsp;<%=image_tag("comment.ico",:size=>"30x20")%>&nbsp;&nbsp;</a> --><a href="#" onclick='postToFeed("<%=posting.caption%>","<%=posting.post%>","<%=posting.pictures[0].image_url.to_s%>"); return false;' data-id="<%=posting.id%>"><%=image_tag("fb1.png",:size=>"30x20")%></a>&nbsp;
            <%= link_to image_tag("twitter1.png",:size=>"30x20"), "http://twitter.com/home?status=#{posting.caption} See complete story on www.shameIndia.com"%>
          <%end%>
        </div>    
      </div>
      <br>
      <div class='span10 offset1 comment-area-<%=posting.id%> comment-area'>
        <!-- <hr style="margin: 20px 38px 20px -25px;"> -->
        <%= render :partial => "comments/comment_section",:collection => posting.comments , :as => :comment,:locals => {:posting => posting } %>
        <%if current_user%>
          <%=form_for([posting,@comment=posting.comments.new],:remote => true, :html => {:class=>"new-comment-#{posting.id} new_comment","data-type" => "html","style"=>"margin-left: 5%;"}) do |f|%>
            <%=f.text_field :content,:style=>"margin-bottom: 0px;"%>
            <%=f.hidden_field :user_id, :value=>current_user.id%>
            <%=f.hidden_field :user_name, :value=>current_user.name%>
            <%=f.hidden_field :commented_on, :value=>Time.now%>
            <%=f.submit "Add Comment",:class=>"btn btn-success","data-id"=>"comment-area-#{posting.id}" %><br>
          <%end%>
        <%end%>
      </div>   
      <div class="clearfix"></div>   
    <%end%>
  </div>  
  <div class='side-bar span3 fixed' style="margin-left:1%;">
    <div class="recent-activities">
      <%if not current_user%>
        <a href="/auth/facebook"><%= image_tag "fb.png" %></a><br><br>
        <a href="/auth/twitter"><%= image_tag "twitter.png" %></a><br>
      <%end%>
      <%= paginate @activities%>
      <% @activities.each do |activity| %>
      <%= activity.owner.name if activity.owner %>
      <%= render_activity activity %>
      <% end %>
      
    </div>

    <%if current_user%>
      <%if @poll%>  
        <%if @poll.poll_answers.select{|c| c.user_id == current_user.id}.empty?%>  
          <div class="polling">
            <%#binding.pry%>
            <hr>
            <%=form_for @poll_answer,:url=>create_poll_answer_path(@poll),:remote=>true,:html => {:class=>"poll_form","data-type" => "html"} do |f|%>
              <%= @poll.question%><br>
              <%= f.hidden_field :user_id,:value => current_user.id%>
              <%= f.radio_button :answer,"Yes"%>Yes<br>
              <%= f.radio_button :answer,"No"%>No<br>
              <%= f.radio_button :answer,"Cant_Say"%>Can't Say<br><br>
              <%= f.submit "Submit"%>
            <%end%>
          </div>
        <%end%>
      <%end%>
    <%end%>  
    <div class="poll-result">
      <%if @previous_poll%>
        <hr>
        Yesterday's Poll result:<br>
        <div class="progress progress-success">
          <%=@yes_count%>%<div class="bar" style="width: <%=@yes_count.to_i%>%"></div>
        </div>
        <div class="progress progress-danger">
          <%=@no_count%>%<div class="bar" style="width: <%=@no_count.to_i%>%"></div>
        </div>
        <div class="progress progress-warning">
          <%=@cant_say_count%>%<div class="bar" style="width: <%=@cant_say_count.to_i%>%"></div>
        </div>
      <%end%>  
    </div>
  </div>
</div>  
<div class="clearfix"></div>








    <script> 
      FB.init({appId: "140476016130992", status: true, cookie: true});

      function postToFeed(capt,post,url) {
        
        // calling the API ...
        
        obj = {
          method: 'feed',
          
          link: 'https://localhost:3000',
          picture: 'http://localhost:3000'+url,
          name: 'India',
          caption: capt,
          description: post
        };

        function callback(response) {
          document.getElementById('msg').innerHTML = "Post ID: " + response['post_id'];
        }

        FB.ui(obj, callback);
      }
    
    </script>
