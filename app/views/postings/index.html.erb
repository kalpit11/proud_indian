<div id='fb-root'></div>
<div class='row-fluid page'>
  <div class='span9 main-area'>
    <div class="search-area">
      <%= form_tag(postings_path,:method=>:get) do%>
        <%if current_user%>
      <a href="#new_post" data-toggle="modal" class="btn" >Post</a>
      <%end%>
        <%=text_field_tag "search[caption]",(params[:search].present? ? params[:search][:caption]: ''), :class=>"input-medium search-query span6", :placeholder=>"Search"%>
        <%=submit_tag "Search" , :class=>'btn btn-info'%>
      <% end %>
      <hr>

            <!-- Modal -->
      <div id="new_post" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
          <h3 id="myModalLabel">New Post</h3>
        </div>
        <div class="modal-body">
          <%@posting=Posting.new%>
          <%= render 'form' %>
        </div>
        <div class="modal-footer">
          <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
          <button class="btn btn-primary">Save changes</button>
        </div>
      </div>
      <!--end of model-->
    </div>
    
    <%@postings.each do |posting|%>
      <div id="post_<%=posting.id%>">
        <%if current_user%>
          <%if current_user.id==posting.user_id%>
            <div class="offset11">
              <%= link_to image_tag("edit.png",:size=>"10x16"),edit_posting_path(posting)%>
              <%= link_to image_tag("delete.png",:size=>"10x16"),posting_path(posting), :method =>:delete%>
            </div>
          <%end%>  
        <%end%>
        <div class="clearfix"></div>
        <ul class="thumbnails">
          <h5><%= posting.user_name%></h5>
          <h3><%= posting.caption%></h3>
          <%@pictures = posting.pictures%>
          <%@pictures.each do |picture|%>
            <li class="span4">
              <div class="thumbnail">
                <a href="#picture_view-<%=posting.id%>" data-toggle="modal"><%= image_tag(picture.image_url,:style=>"width:300px;height:200px;")%></a>
              </div>
            </li>
          <%end%>


                    <!-- Modal -->
          <div id="picture_view-<%=posting.id%>" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
              <h3 id="myModalLabel-<%=posting.id%>"><%=posting.caption%></h3>
            </div>
            <div class="modal-body">
              <div id="myCarousel-<%=posting.id%>" class="carousel slide">
              <!-- Carousel items -->
              <div class="carousel-inner">
                <%@pictures = posting.pictures%>
                <%@pictures.each do |picture|%>
                
                  <div class="item"><%= image_tag(picture.image_url,:style=>"width:600px;height:400px;")%></div>
                
                <%end%>

              </div>
              <p style="color: gray;"><%= posting.post%></p>  
              <!-- Carousel nav -->
              <a class="carousel-control left" href="#myCarousel-<%=posting.id%>" data-slide="prev">&lsaquo;</a>
              <a class="carousel-control right" href="#myCarousel-<%=posting.id%>" data-slide="next">&rsaquo;</a>
            </div>
            </div>
            <div class="modal-footer">

              <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
              
            </div>
          </div>
          <!-- end of model -->



          <div class="clearfix"></div>
          <p style="color: gray;"><%= posting.post%></p>          
        </ul>
        <%#binding.pry%>
        <%if current_user%>
          <b class="like"><%=posting.post_likes.count%></b>&nbsp;
          <%if posting.post_likes.select{|c|c.user_id == current_user.id}.empty?%>
            <%= link_to "Like",add_like_path(posting),:class=>"like_post", :remote=>true%>
          <%else%>
            <a href="#">Likes</a>
          <%end%>

          |<a href="#" id='comment'>Comment</a>|<a href="#" onclick='postToFeed("<%=posting.caption%>","<%=posting.post%>","<%=posting.pictures[0].image_url.to_s%>"); return false;' data-id="<%=posting.id%>">Share</a>
          <%= link_to "tweet me", "http://twitter.com/home?status=#{posting.caption} See complete story on www.shameIndia.com"%>
        <%end%>  
      </div>
      <br>
      <div class='span12 comment-area-<%=posting.id%> comment-area'>
        <hr style="margin: 20px 38px 20px -25px;">
        <%if current_user%>
          <%=form_for([posting,@comment=posting.comments.new],:remote => true, :html => {:class=>"new-comment-#{posting.id} new_comment","data-type" => "html"}) do |f|%>
            <%=f.text_field :content,:style=>"margin-bottom: 0px;"%>
            <%=f.hidden_field :user_id, :value=>current_user.id%>
            <%=f.hidden_field :user_name, :value=>current_user.name%>
            <%=f.hidden_field :commented_on, :value=>Time.now%>
            <%=f.submit "Add Comment",:class=>"btn btn-success","data-id"=>"comment-area-#{posting.id}" %><br>
          <%end%>
        <%end%>
        <hr style="width: 87%;">
        <%= render :partial => "comments/comment_section",:collection => posting.comments , :as => :comment,:locals => {:posting => posting } %>
      </div>      
    <%end%>
  </div>  
  <div class='side-bar span3 fixed'>
    <div class="recent-activities">
      <%if not current_user%>
        <a href="/auth/facebook"><%= image_tag "fb.png" %></a><br><br>
        <a href="/auth/twitter"><%= image_tag "twitter.png" %></a><br>
      <%end%>
      <%= paginate @activities%>
      <% @activities.each do |activity| %>
      <%= activity.owner.name if activity.owner %>
      <%= render_activity activity %>
      <% end %>
      <hr>
    </div>

    <%if current_user%>
      <%if @poll.poll_answers.select{|c| c.user_id == current_user.id}.empty?%>  
        <div class="polling">
          <%#binding.pry%>
          <%=form_for @poll_answer,:url=>create_poll_answer_path(@poll),:remote=>true,:html => {:class=>"poll_form","data-type" => "html"} do |f|%>
            <%= @poll.question%><br>
            <%= f.hidden_field :user_id,:value => current_user.id%>
            <%= f.radio_button :answer,"Yes"%>Yes<br>
            <%= f.radio_button :answer,"No"%>No<br>
            <%= f.radio_button :answer,"Can't_Say"%>Can't Say<br><br>
            <%= f.submit "Submit"%>
          <%end%>
        </div>
      <%end%>
    <%end%>  
  </div>
</div>  
<div class="clearfix"></div>








    <script> 
      FB.init({appId: "140476016130992", status: true, cookie: true});

      function postToFeed(capt,post,url) {
        
        // calling the API ...
        
        obj = {
          method: 'feed',
          redirect_uri: 'http://localhost:3000/',
          link: 'https://localhost:3000',
          picture: 'http://localhost:3000'+url,
          name: 'India',
          caption: capt,
          description: post
        };

        function callback(response) {
          document.getElementById('msg').innerHTML = "Post ID: " + response['post_id'];
        }

        FB.ui(obj, callback);
      }
    
    </script>
